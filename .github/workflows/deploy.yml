name: Deploy Midas Mining System

on:
  push:
    branches: [main]
    paths:
      - '*.py'
      - 'scripts/**'
      - 'config/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt || echo "No requirements.txt"
          pip install pytest ruff || true

      - name: Lint
        run: ruff check . || echo "No ruff config"

      - name: Test
        run: pytest tests/ -v || echo "No tests yet"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Setup SSH Key
        env:
          SSH_KEY: ${{ secrets.LAB_SERVER_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan gpu-server.vibhavaggarwal.com >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to GPU Server
        run: |
          ssh -o ProxyCommand="cloudflared access ssh --hostname gpu-server.vibhavaggarwal.com --service-token-id 55df69f3b2ea04e12c30498a120b050b.access --service-token-secret c363a2caa502d2e0bdaddc7ddc1c26c6003d33517fef2712209ccb8b369a4af7" \
              -o StrictHostKeyChecking=no \
              -i ~/.ssh/id_ed25519 \
              vibhavaggarwal@gpu-server.vibhavaggarwal.com << 'ENDSSH'
            cd /home/vibhavaggarwal/Projects/production/midas || mkdir -p /home/vibhavaggarwal/Projects/production/midas
            git pull origin main || git clone https://github.com/Vibhav-Aggarwal/Midas.git .
            echo "Midas: Mining scripts updated"
          ENDSSH

      - name: Deployment Complete
        run: echo "âœ… Midas deployed to GPU server"
